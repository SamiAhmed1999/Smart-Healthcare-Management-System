<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Data Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for smooth scrolling and clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .sidebar-item-active {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            font-weight: 600;
        }
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }
        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 4px;
        }
        .loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body>

<script>
    // --- Data Schema and Initial Data (Moved outside module for global access) ---
    const tableSchemas = {
        Patients: ['ID', 'Name', 'Age', 'Gender', 'Contact'],
        MedicalRecords: ['ID', 'PatientID', 'Diagnosis', 'Treatment'],
        Doctors: ['ID', 'Name', 'Specialization', 'Schedule'],
        Appointments: ['ID', 'PatientID', 'DoctorID', 'DateTime', 'Status'],
        Prescriptions: ['ID', 'PatientID', 'Medicine', 'IssueDate'],
        Investigations: ['ID', 'PatientID', 'TestType', 'Results'],
        // --- MODIFICATION: Added 'PatientName' ---
        Billing: ['ID', 'PatientID', 'PatientName', 'Amount', 'Status'],
        InsuranceClaims: ['ID', 'PatientID', 'PatientName', 'Status', 'Amount'],
        // --- END MODIFICATION ---
        SymptomsInput: ['ID', 'PatientID', 'Symptom', 'Date'],
        DiseasePredictions: ['ID', 'PatientID', 'Disease', 'Confidence'],
        Recommendations: ['ID', 'PatientID', 'Type', 'Details'],
        HealthReminders: ['ID', 'PatientID', 'Type', 'NextDate']
    };

    // Simulated In-Memory Database (Moved outside module for global access)
    let dataStore = {
        Patients: [
            { ID: 'P001', Name: 'Alice Smith', Age: 35, Gender: 'Female', Contact: '555-1234' },
            { ID: 'P002', Name: 'Bob Johnson', Age: 52, Gender: 'Male', Contact: '555-5678' }
        ],
        Doctors: [
            { ID: 'D001', Name: 'Dr. Lee', Specialization: 'Cardiology', Schedule: 'Mon-Fri' },
            { ID: 'D002', Name: 'Dr. Khan', Specialization: 'Pediatrics', Schedule: 'Tue-Sat' }
        ],
        Appointments: [
            { ID: 'A001', PatientID: 'P001', DoctorID: 'D001', DateTime: '2025-12-01 10:00', Status: 'Booked' }
        ],
        MedicalRecords: [],
        Prescriptions: [],
        Investigations: [],
        Billing: [],
        InsuranceClaims: [],
        SymptomsInput: [],
        DiseasePredictions: [],
        Recommendations: [],
        HealthReminders: []
    };
    
    // --- Role Definitions (Moved outside module for global access) ---
    const ROLE_MAPPINGS = {
        // Mocked User ID for Login: [Tables Accessible]
        'ADMIN': ['Patients', 'MedicalRecords', 'Doctors', 'Appointments', 'Prescriptions', 'Investigations', 'Billing', 'InsuranceClaims', 'SymptomsInput', 'DiseasePredictions', 'Recommendations', 'HealthReminders'],
        'D000': ['Doctors', 'MedicalRecords', 'Appointments', 'Prescriptions', 'Investigations', 'Recommendations'], // Doctor
        'P000': ['Patients', 'SymptomsInput', 'HealthReminders'], // Patient
        'B000': ['Billing', 'InsuranceClaims'] // Billing Admin
    };

    // --- Auto-login as B000 and set default table ---
    let currentTable = 'Billing'; // Default to Billing table
    let editRecordId = null; 
    window.userRole = 'B000'; // Force user role
    window.userId = 'mock-user-B000'; // Force user ID
    window.isAuthReady = true; // Force auth readiness

</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables (will be defined by the environment, mocked locally)
    const appId = 'default-app-id';
    const firebaseConfig = {}; 
    const initialAuthToken = null;

    window.auth = null;
    
    // --- Local Simulation Mode ---
    if (Object.keys(firebaseConfig).length === 0) {
        console.warn("Running in local simulation mode. Firebase functions are mocked.");

        /** Mocks the Firebase sign-in process for local demo */
        window.handleSimulatedLogin = (loginId) => {
            console.error("Login is disabled. Please logout first.");
        };

        // Mock the logout handler
        window.handleLogout = () => {
            window.userId = null;
            window.userRole = null;
            document.getElementById('main-dashboard').classList.add('hidden');
            document.getElementById('auth-gate').classList.add('loading-screen');
            document.getElementById('auth-gate').classList.remove('hidden');
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('login-error-message').classList.add('hidden');
            // In a real app, this would redirect to a login page
            alert("Logout Simulated. You are logged out.");
        };

        // renderApp() is called directly, using the globally set B000 role.
        window.renderApp();

    } else {
        // --- LIVE ENVIRONMENT / Real Firebase Setup (kept for future use) ---
        console.log("Running in live mode, but auto-login is still active.");
        window.renderApp(); 
    }
</script>

<div id="auth-gate" class="loading-screen hidden">
    <div id="loading-spinner" class="flex flex-col items-center">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-600">Checking credentials...</p>
    </div>

    <div id="login-form" class="hidden w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
        <h2 class="text-3xl font-extrabold text-gray-800 text-center mb-6">Role-Based Dashboard Login</h2>
        <p class="text-sm text-gray-600 mb-4 text-center">Enter your access ID to view features.</p>
        <div class="space-y-4">
            <input type="text" id="login-id-input" placeholder="Enter Role ID (e.g., D000)" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" 
                   value="" required>
            <input type="password" placeholder="Password (ignored)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" value="••••••••" disabled>
            <p id="login-error-message" class="text-sm text-red-600 hidden">Invalid ID. Check the list below.</p>
            <button onclick="window.handleSimulatedLogin(document.getElementById('login-id-input').value)"
                    class="w-full flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
                <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                Access Dashboard
            </button>
        </div>
        <div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-700">
            <p class="font-semibold mb-2">Available Access IDs:</p>
            <ul class="list-disc list-inside space-y-1">
                <li><span class="font-mono text-sm text-blue-600">ADMIN</span>: All Features (12 Tables)</li>
                <li><span class="font-mono text-sm text-blue-600">D000</span>: Doctor Features (6 Tables)</li>
                <li><span class="font-mono text-sm text-blue-600">P000</span>: Patient Features (3 Tables)</li>
                <li><span class="font-mono text-sm text-blue-600">B000</span>: Billing Features (2 Tables)</li>
            </ul>
        </div>
    </div>
</div>


<div id="main-dashboard" class="hidden flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 p-4 flex-shrink-0 overflow-y-auto">
        <h2 class="text-xl font-bold mb-6 text-indigo-700">Access Role: <span id="current-user-role" class="font-mono text-blue-600"></span></h2>
        <h3 class="text-lg font-bold mb-3 text-gray-700">Accessible Features</h3>
        <nav id="table-list">
            </nav>
        <p class="mt-4 text-xs text-gray-500 p-2 border-t pt-4">
            *CRUD operations are simulated in-memory.
        </p>
    </aside>

    <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800">
                Clinical Management Dashboard
            </h1>
            <button onclick="window.handleLogout()"
                    class="flex items-center text-sm font-medium text-red-500 hover:text-red-700 transition duration-150">
                <i data-lucide="log-out" class="w-4 h-4 mr-1"></i>
                Logout
            </button>
        </div>
        <p class="text-gray-500 mb-6">
            Managing data for the <span id="current-table-title" class="font-semibold text-indigo-600">Patients</span> table.
        </p>

        <div id="billing-stats-container" class="hidden mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Billing Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-custom border border-gray-100 flex items-start">
                    <div class="p-3 bg-red-100 rounded-lg mr-4">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-500">Total Outstanding</span>
                        <p id="stat-outstanding" class="text-3xl font-bold text-gray-800">৳0.00</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-custom border border-gray-100 flex items-start">
                    <div class="p-3 bg-yellow-100 rounded-lg mr-4">
                        <i data-lucide="file-clock" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-500">Pending Claims</span>
                        <p id="stat-pending-claims" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-custom border border-gray-100 flex items-start">
                    <div class="p-3 bg-green-100 rounded-lg mr-4">
                        <i data-lucide="dollar-sign" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-500">Total Billed</span>
                        <p id="stat-total-billed" class="text-3xl font-bold text-gray-800">৳0.00</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-white rounded-xl shadow-custom border border-gray-100">
            <div class="flex w-full sm:w-1/2 relative">
                <input type="text" id="search-input" oninput="handleSearch()" placeholder="Search current table data..."
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </span>
            </div>
            <button onclick="showModal('Add')"
                    class="w-full sm:w-auto flex items-center justify-center px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                Add New Record
            </button>
        </div>

        <div class="bg-white rounded-xl shadow-custom overflow-hidden">
            <div class="table-container overflow-x-auto">
                <table id="data-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Add New Record</h3>
            <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <form id="data-form" onsubmit="handleSave(event)">
            <div id="modal-fields" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="hideModal()"
                        class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">
                    Cancel
                </button>
                <button type="submit" id="save-button"
                        class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- Utility Functions (Depend on global variables defined above) ---

    /** Generates a short unique ID for simulation */
    const generateId = (prefix) => prefix + Math.random().toString(36).substring(2, 6).toUpperCase();

    /** Initializes the sidebar and dashboard on load */
    const initializeDashboard = () => {
        lucide.createIcons();
    };

    // --- Authentication Gate Logic ---

    /** Toggles visibility based on authentication state and user role */
    window.renderApp = () => {
        const authGate = document.getElementById('auth-gate');
        const mainDashboard = document.getElementById('main-dashboard');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loginForm = document.getElementById('login-form');
        
        const defaultTable = window.userRole && ROLE_MAPPINGS[window.userRole] ? ROLE_MAPPINGS[window.userRole][0] : 'Patients';

        if (window.isAuthReady) {
            if (window.userId && window.userRole) {
                // Logged in: Show Dashboard
                authGate.classList.add('hidden');
                authGate.classList.remove('loading-screen');
                mainDashboard.classList.remove('hidden');
                
                currentTable = defaultTable; 
                
                document.getElementById('current-user-role').textContent = window.userRole;
                renderSidebar();
                loadTable(currentTable); 

            } else {
                // Auth check complete, but not logged in: Show Login Form
                loadingSpinner.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }
        lucide.createIcons();
    };


    // --- Sidebar Logic ---

    /** Renders the list of tables in the sidebar based on the current user's role */
    const renderSidebar = () => {
        const tableList = document.getElementById('table-list');
        tableList.innerHTML = '';
        
        const accessibleTables = ROLE_MAPPINGS[window.userRole] || [];

        accessibleTables.forEach(tableName => {
            const isActive = tableName === currentTable;
            const button = document.createElement('button');
            button.className = `w-full text-left p-3 my-1 rounded-lg transition duration-150 hover:bg-gray-100 ${isActive ? 'sidebar-item-active hover:bg-blue-600' : 'text-gray-700'}`;
            button.textContent = tableName;
            button.onclick = () => loadTable(tableName);
            tableList.appendChild(button);
        });
        lucide.createIcons();
    };

    /** Switches the dashboard to a new table */
    window.loadTable = (tableName) => {
        if (!ROLE_MAPPINGS[window.userRole].includes(tableName)) {
             console.error(`Access Denied: Role ${window.userRole} cannot access the ${tableName} table.`);
             return;
        }

        currentTable = tableName;
        document.getElementById('current-table-title').textContent = tableName;
        document.getElementById('search-input').value = ''; 
        renderSidebar();
        renderTable(dataStore[currentTable]);
        renderDashboardStats(tableName);
    };

    // --- Table Rendering Logic ---

    /** Renders the header and body of the data table */
    const renderTable = (data) => {
        const schema = tableSchemas[currentTable];
        const table = document.getElementById('data-table');
        const thead = table.querySelector('thead tr');
        const tbody = document.getElementById('table-body');

        // 1. Render Headers
        thead.innerHTML = '';
        schema.forEach(attribute => {
            const th = document.createElement('th');
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            th.textContent = attribute;
            thead.appendChild(th);
        });
        const actionTh = document.createElement('th');
        actionTh.className = 'px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-36';
        actionTh.textContent = 'Actions';
        thead.appendChild(actionTh);

        // 2. Render Body Rows
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${schema.length + 1}" class="text-center py-8 text-gray-500">No records found for ${currentTable}. Click "Add New Record" to create one.</td></tr>`;
            return;
        }

        data.forEach(record => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';

            schema.forEach(attribute => {
                const cell = document.createElement('td');
                cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                cell.textContent = record[attribute] !== undefined ? record[attribute] : 'N/A';
                row.appendChild(cell);
            });

            // Action Buttons
            const actionCell = document.createElement('td');
            actionCell.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2';

            const editBtn = document.createElement('button');
            editBtn.innerHTML = '<i data-lucide="pencil" class="w-4 h-4 text-indigo-500 hover:text-indigo-700"></i>';
            editBtn.title = 'Edit';
            editBtn.onclick = () => showModal('Edit', record);
            editBtn.className = 'inline-flex items-center p-2 rounded-full hover:bg-indigo-50 transition';

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-700"></i>';
            deleteBtn.title = 'Delete';
            deleteBtn.onclick = () => handleDelete(record.ID);
            deleteBtn.className = 'inline-flex items-center p-2 rounded-full hover:bg-red-50 transition';

            actionCell.appendChild(editBtn);
            actionCell.appendChild(deleteBtn);
            row.appendChild(actionCell);
            tbody.appendChild(row);
        });
        lucide.createIcons();
    };

    // --- Dashboard Stats Rendering ---

    /** Renders billing-specific KPI stats if a billing table is selected */
    const renderDashboardStats = (tableName) => {
        const statsContainer = document.getElementById('billing-stats-container');
        
        const isBillingContext = (window.userRole === 'B000' || window.userRole === 'ADMIN') && 
                                  (tableName === 'Billing' || tableName === 'InsuranceClaims');

        if (isBillingContext) {
            statsContainer.classList.remove('hidden');
            
            const outstanding = dataStore.Billing
                .filter(b => b.Status === 'Pending')
                .reduce((sum, b) => sum + (parseFloat(b.Amount) || 0), 0);
            
            const pendingClaims = dataStore.InsuranceClaims
                .filter(c => c.Status === 'Pending' || c.Status === 'Submitted').length;
            
            const totalBilled = dataStore.Billing
                .reduce((sum, b) => sum + (parseFloat(b.Amount) || 0), 0);

            document.getElementById('stat-outstanding').textContent = `৳${outstanding.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            document.getElementById('stat-pending-claims').textContent = pendingClaims;
            document.getElementById('stat-total-billed').textContent = `৳${totalBilled.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;

            lucide.createIcons();
        } else {
            statsContainer.classList.add('hidden');
        }
    };


    // --- CRUD Operations (Simulated) ---

    /** Handles the Search/Filter functionality */
    window.handleSearch = () => {
        const query = document.getElementById('search-input').value.toLowerCase();
        const allData = dataStore[currentTable];
        const schema = tableSchemas[currentTable];

        if (!query) {
            renderTable(allData);
            return;
        }

        const filteredData = allData.filter(record => {
            return schema.some(attribute => {
                const value = record[attribute];
                return String(value).toLowerCase().includes(query);
            });
        });

        renderTable(filteredData);
    };

    /** Handles adding or updating a record */
    window.handleSave = (event) => {
        event.preventDefault();
        const form = event.target;
        const schema = tableSchemas[currentTable];
        const newRecord = {};
        let isNew = editRecordId === null;

        schema.forEach(attr => {
            const input = form.elements[attr];
            if (input) {
                let value = input.value;
                if (attr === 'Age' || attr === 'Amount') {
                    value = parseFloat(value) || 0;
                }
                newRecord[attr] = value;
            }
        });

        if (isNew) {
            const idAttr = schema[0];
            const prefix = currentTable.substring(0, 1);
            newRecord[idAttr] = generateId(prefix);
            dataStore[currentTable].push(newRecord);
        } else {
            const index = dataStore[currentTable].findIndex(r => r[schema[0]] === editRecordId);
            if (index !== -1) {
                newRecord[schema[0]] = editRecordId;
                dataStore[currentTable][index] = newRecord;
            }
        }

        hideModal();
        handleSearch(); 
        renderDashboardStats(currentTable);
    };

    /** Handles deleting a record */
    window.handleDelete = (idToDelete) => {
        console.error("Deletion confirmation dialog is blocked by security policy. A custom modal would be required here.");
        const schema = tableSchemas[currentTable];
        const primaryKey = schema[0];
        const initialLength = dataStore[currentTable].length;

        dataStore[currentTable] = dataStore[currentTable].filter(record => record[primaryKey] !== idToDelete);

        if (dataStore[currentTable].length < initialLength) {
            console.log(`[SIMULATED] Record ${idToDelete} deleted successfully.`);
        } else {
            console.error(`[SIMULATED] Deletion failed: Record ID ${idToDelete} not found.`);
        }

        handleSearch(); 
        renderDashboardStats(currentTable);
    };

    // --- MODIFICATION: New function to auto-fill patient name ---
    /** Auto-fills the patient name input based on the Patient ID */
    window.autoFillPatientName = (patientId) => {
        const nameInput = document.getElementById('PatientName');
        if (!nameInput) return; // Exit if the field doesn't exist on this modal

        const patient = dataStore.Patients.find(p => p.ID.toLowerCase() === patientId.toLowerCase());
        
        if (patient) {
            nameInput.value = patient.Name;
        } else {
            nameInput.value = 'Patient Not Found';
        }
    };

    // --- Modal Logic ---

    /** Displays the Add/Edit Modal */
    window.showModal = (mode, record = {}) => {
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalFields = document.getElementById('modal-fields');
        const saveButton = document.getElementById('save-button');
        const schema = tableSchemas[currentTable];

        modalTitle.textContent = `${mode} ${currentTable} Record`;
        saveButton.textContent = mode === 'Add' ? 'Add Record' : 'Save Changes';
        modalFields.innerHTML = '';
        editRecordId = mode === 'Edit' ? record[schema[0]] : null;

        schema.forEach((attr, index) => {
            const isPrimaryKey = index === 0;
            const labelText = attr.replace(/([A-Z])/g, ' $1').trim(); 
            const value = record[attr] !== undefined ? record[attr] : '';

            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'flex flex-col';

            const label = document.createElement('label');
            label.htmlFor = attr;
            label.className = 'text-sm font-medium text-gray-700 mb-1';
            label.textContent = labelText;
            fieldDiv.appendChild(label);

            const input = document.createElement('input');
            input.id = attr;
            input.name = attr;
            input.value = value;
            input.required = !isPrimaryKey && attr !== 'PatientName'; // PatientName is auto-filled
            input.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150';

            if (isPrimaryKey) {
                input.readOnly = true;
                input.placeholder = mode === 'Add' ? 'Auto-Generated on Save' : value;
                input.className += ' bg-gray-100 text-gray-500 cursor-not-allowed';
            } 
            // --- MODIFICATION: Add auto-fill logic ---
            else if (attr === 'PatientID') {
                input.onblur = () => autoFillPatientName(input.value);
            } 
            else if (attr === 'PatientName') {
                input.readOnly = true;
                input.placeholder = 'Auto-fills after entering Patient ID';
                input.className += ' bg-gray-100 text-gray-500 cursor-not-allowed';
            } 
            // --- END MODIFICATION ---
            else if (attr.includes('Date') || attr.includes('Time')) {
                input.type = 'text'; 
                input.placeholder = 'YYYY-MM-DD HH:MM (e.g., 2025-12-01 10:00)';
            } else if (attr === 'Age' || attr === 'Amount') {
                input.type = 'number';
                input.step = 'any';
            } else {
                input.type = 'text';
            }

            fieldDiv.appendChild(input);
            modalFields.appendChild(fieldDiv);
        });

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };

    /** Hides the Add/Edit Modal */
    window.hideModal = () => {
        const modal = document.getElementById('modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        editRecordId = null;
    };

    // Initialize the dashboard when the window loads
    window.onload = initializeDashboard;

    // Close modal when clicking outside
    document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') {
            hideModal();
        }
    });

</script>

</body>
</html>